# Prisma Build Tool - Plugin System Design

**Status:** Design Proposal
**Version:** 1.0
**Date:** 2025-10-23

---

## Overview

Extend the Prisma build tool with a plugin system that allows automated schema generation from external tools like Better Auth, Prisma extensions, and custom generators.

---

## Problem Statement

### Current Limitation

Libraries like Better Auth can generate Prisma schemas automatically based on configuration:

```bash
npx @better-auth/cli generate --output=./prisma/schema.prisma
```

However, this is:
- Manual process
- Separate from our build tool
- No integration with schema composition
- Requires running multiple commands
- Easy to forget to regenerate

### Desired Outcome

Integrate schema generators directly into the build process:
- Automatic generation during build
- Plugin-based architecture
- Configuration via comments
- Multiple plugins per schema
- Clear generation boundaries per plugin

---

## Plugin Comment Syntax

### Basic Plugin Directive

```prisma
// @prisma-plugin: <plugin-name>
// @prisma-plugin-config: <json-config>
```

### Better Auth Example

```prisma
// libs/api/prisma/schema.prisma

// @prisma-plugin: better-auth
// @prisma-plugin-config: { "source": "../src/auth/auth.config.ts", "adapter": "prisma", "provider": "postgresql" }

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["auth"]
}

// ============================================================================
// GENERATED BY PLUGIN: better-auth
// Source: ../src/auth/auth.config.ts
// Last updated: 2025-10-23T12:00:00Z
// ============================================================================

model User {
  id    String @id
  email String @unique
  // ... generated by Better Auth CLI
}

// ============================================================================
// END PLUGIN GENERATED: better-auth
// ============================================================================
```

---

## Architecture

### Plugin Registry

```typescript
// cli/tools/src/commands/prisma/plugins/registry.ts

export interface PrismaPlugin {
  name: string;
  generate: (config: PluginConfig, context: PluginContext) => Promise<string>;
  validate?: (config: PluginConfig) => boolean;
}

export const pluginRegistry = new Map<string, PrismaPlugin>([
  ['better-auth', betterAuthPlugin],
  ['custom-generator', customGeneratorPlugin],
]);
```

### Plugin Execution Flow

```
1. Parse schema file
   ↓
2. Extract plugin directives
   // @prisma-plugin: better-auth
   // @prisma-plugin-config: {...}
   ↓
3. For each plugin:
   a. Load plugin from registry
   b. Parse plugin config
   c. Execute plugin.generate()
   d. Insert result into schema
   ↓
4. Continue with import resolution
   (plugins run BEFORE imports)
   ↓
5. Merge all schemas
   ↓
6. Write final schema
```

### Plugin Types

**Type 1: CLI-Based Plugins**
- Execute external CLI commands
- Parse stdout for generated schema
- Example: Better Auth CLI, Prisma extensions

**Type 2: Code-Based Plugins**
- Load TypeScript/JavaScript config
- Generate schema programmatically
- Example: Custom model generators

**Type 3: Template-Based Plugins**
- Apply templates with substitution
- Example: CRUD scaffolding, audit fields

---

## Better Auth Plugin Implementation

### Plugin Definition

```typescript
// cli/tools/src/commands/prisma/plugins/better-auth.ts

import { exec } from 'node:child_process';
import { promisify } from 'node:util';
import type { PrismaPlugin, PluginConfig } from '../types';

const execAsync = promisify(exec);

export const betterAuthPlugin: PrismaPlugin = {
  name: 'better-auth',

  async generate(config: PluginConfig, context: PluginContext): Promise<string> {
    // 1. Validate config
    if (!config.source) {
      throw new Error('better-auth plugin requires "source" config pointing to auth.config.ts');
    }

    // 2. Run Better Auth CLI
    const { stdout } = await execAsync(
      `npx @better-auth/cli generate --config=${config.source} --adapter=prisma --provider=${config.provider || 'postgresql'}`
    );

    // 3. Parse generated schema
    const schema = parseGeneratedSchema(stdout);

    // 4. Apply namespace if needed
    if (context.namespace) {
      return applyNamespace(schema, context.namespace);
    }

    return schema;
  },

  validate(config: PluginConfig): boolean {
    return !!config.source && typeof config.source === 'string';
  },
};
```

### Usage in Schema

```prisma
// libs/api/prisma/schema.prisma

// @prisma-plugin: better-auth
// @prisma-plugin-config: { "source": "../src/auth/auth.config.ts", "provider": "postgresql" }

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["auth"]
}

// Plugin-generated section will be inserted here during build
```

### Build Process

```bash
pnpm tools prisma build libs/api/prisma/schema.prisma

# Process:
# 1. Detect better-auth plugin directive
# 2. Run: npx @better-auth/cli generate --config=../src/auth/auth.config.ts
# 3. Parse Better Auth output
# 4. Insert into schema with plugin boundaries
# 5. Apply @@schema("auth") to all models
# 6. Write updated schema
# 7. Continue with normal build (imports, etc.)
```

---

## Plugin Configuration

### Configuration Format

```typescript
interface PluginConfig {
  // Plugin name
  name: string;

  // Plugin-specific configuration (parsed from JSON comment)
  config: {
    source?: string;      // Source file path
    provider?: string;    // Database provider
    namespace?: string;   // Database schema namespace
    output?: string;      // Output customization
    [key: string]: unknown; // Additional plugin-specific options
  };

  // Line number of plugin directive
  line: number;
}
```

### Multiple Plugins

```prisma
// @prisma-plugin: better-auth
// @prisma-plugin-config: { "source": "../src/auth/auth.config.ts" }

// @prisma-plugin: audit-fields
// @prisma-plugin-config: { "models": ["User", "Post"] }

// @prisma-plugin: soft-delete
// @prisma-plugin-config: { "models": ["User", "Post"] }
```

Each plugin gets its own generation boundary:

```prisma
// === GENERATED BY PLUGIN: better-auth ===
model User { ... }
// === END PLUGIN: better-auth ===

// === GENERATED BY PLUGIN: audit-fields ===
// (Audit fields added to existing models)
// === END PLUGIN: audit-fields ===
```

---

## Generation Boundaries

### Plugin Boundaries vs Import Boundaries

**Plugin Boundaries** (per plugin):
```prisma
// ============================================================================
// GENERATED BY PLUGIN: better-auth
// Source: ../src/auth/auth.config.ts
// Last updated: 2025-10-23T12:00:00Z
// ============================================================================

[PLUGIN GENERATED CONTENT]

// ============================================================================
// END PLUGIN GENERATED: better-auth
// ============================================================================
```

**Import Boundaries** (all imports combined):
```prisma
// ============================================================================
// GENERATED SECTION - DO NOT EDIT MANUALLY
// This section is automatically generated by the Prisma Build Tool
// Generated from:
//   - @libs/api/prisma/schema.prisma
// ============================================================================

[IMPORTED CONTENT]

// ============================================================================
// END GENERATED SECTION
// ============================================================================
```

### Combined Example

```prisma
// @prisma-plugin: better-auth
// @prisma-import: @libs/payments/prisma/schema.prisma

datasource db { ... }
generator client { ... }

// === PLUGIN: better-auth ===
model User { ... }
// === END PLUGIN ===

// === GENERATED (IMPORTS) ===
model Payment { ... }
// === END GENERATED ===

// Native models
model Post { ... }
```

---

## Build Tool Updates

### Parser Changes

```typescript
// Add to ParsedSchema interface
export interface ParsedSchema {
  // ... existing fields
  plugins: PluginDirective[];
}

export interface PluginDirective {
  name: string;
  config: Record<string, unknown>;
  line: number;
}

// New parser function
export function extractPlugins(content: string): PluginDirective[] {
  const plugins: PluginDirective[] = [];
  const lines = content.split('\n');

  for (let i = 0; i < lines.length; i++) {
    const pluginMatch = /^\/\/\s*@prisma-plugin:\s*(.+)$/. exec(lines[i]);
    if (pluginMatch) {
      const name = pluginMatch[1].trim();

      // Look for config on next line
      const configMatch = /^\/\/\s*@prisma-plugin-config:\s*(.+)$/.exec(lines[i + 1]);
      const config = configMatch ? JSON.parse(configMatch[1]) : {};

      plugins.push({ name, config, line: i });
    }
  }

  return plugins;
}
```

### Build Process

```typescript
export async function buildSchema(options: BuildOptions): Promise<void> {
  // 1. Parse entry schema
  const entrySchema = await parseSchema(schemaPath);

  // 2. Execute plugins FIRST (before imports)
  for (const plugin of entrySchema.plugins) {
    const executor = pluginRegistry.get(plugin.name);
    if (!executor) {
      console.warn(`Unknown plugin: ${plugin.name}`);
      continue;
    }

    const generated = await executor.generate(plugin.config, {
      namespace: entrySchema.dbSchema,
      schemaPath,
    });

    // Insert into schema
    entrySchema.content = insertPluginContent(
      entrySchema.content,
      plugin.name,
      generated
    );
  }

  // 3. Build dependency graph (existing)
  const graphResult = await buildDependencyGraph(schemaPath);

  // 4. Merge schemas (existing)
  const merged = await mergeSchemas(...);

  // 5. Write output
  await writeFile(schemaPath, merged.content);
}
```

---

## Better Auth Integration

### Config File Approach

**Better Auth Config:**
```typescript
// libs/api/src/auth/auth.config.ts

import { betterAuth } from "better-auth";
import { prismaAdapter } from "better-auth/adapters/prisma";
import { prisma } from "../database/prisma.client";

export const auth = betterAuth({
  database: prismaAdapter(prisma, {
    provider: "postgresql",
  }),
  emailAndPassword: { enabled: true },
  // ... other config
});
```

**Schema with Plugin:**
```prisma
// libs/api/prisma/schema.prisma

// @prisma-plugin: better-auth
// @prisma-plugin-config: { "source": "../src/auth/auth.config.ts", "provider": "postgresql" }

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["auth"]
}

// ============================================================================
// GENERATED BY PLUGIN: better-auth
// ============================================================================

// (Better Auth CLI generates models here during build)

// ============================================================================
// END PLUGIN GENERATED: better-auth
// ============================================================================
```

### Workflow

```bash
# 1. Modify Better Auth config
# edit libs/api/src/auth/auth.config.ts

# 2. Rebuild schema (plugin runs automatically)
cd libs/api
pnpm prisma:build

# 3. Better Auth CLI detects changes and regenerates
# 4. Schema updated with new models
# 5. prisma generate runs automatically
```

---

## Alternative: Inline Generation

Instead of external CLI, parse the config directly:

```typescript
export const betterAuthPlugin: PrismaPlugin = {
  name: 'better-auth',

  async generate(config: PluginConfig): Promise<string> {
    // 1. Load auth config
    const authConfig = await import(config.source);

    // 2. Analyze config to determine required models
    const models = [];

    if (authConfig.emailAndPassword?.enabled) {
      models.push(generateUserModel());
      models.push(generateAccountModel());
    }

    if (authConfig.session) {
      models.push(generateSessionModel());
    }

    // 3. Return combined models
    return models.join('\n\n');
  },
};
```

This avoids external CLI dependency but requires maintaining model templates.

---

## Recommended Approach

### Hybrid Strategy

1. **Phase 1:** CLI-based plugin system (simple, leverages existing tools)
   - Use `// @prisma-plugin: better-auth`
   - Execute `@better-auth/cli generate`
   - Parse output and insert into schema

2. **Phase 2:** Config-based generation (advanced, no external deps)
   - Parse auth config directly
   - Generate models from templates
   - More control over output

3. **Phase 3:** Plugin marketplace
   - Allow third-party plugins
   - Plugin discovery
   - Versioning

---

## Implementation Plan

### 1. Add Plugin Parser (Week 1)

```typescript
// types.ts
export interface PluginDirective {
  name: string;
  config: Record<string, unknown>;
  line: number;
  boundaryStart?: number;
  boundaryEnd?: number;
}

// parser.ts
export function extractPlugins(content: string): PluginDirective[] {
  // Parse @prisma-plugin comments
  // Parse @prisma-plugin-config JSON
  // Detect existing plugin boundaries
}
```

### 2. Create Plugin Registry (Week 1)

```typescript
// plugins/registry.ts
export interface PrismaPlugin {
  name: string;
  description: string;
  generate: (config: unknown, context: PluginContext) => Promise<string>;
  validate?: (config: unknown) => ValidationResult;
}

// plugins/better-auth.ts
export const betterAuthPlugin: PrismaPlugin = {
  name: 'better-auth',
  description: 'Generate auth models from Better Auth configuration',
  generate: async (config, context) => {
    // Implementation
  },
};
```

### 3. Integrate into Build Process (Week 1)

```typescript
// build.ts
export async function buildSchema(options: BuildOptions): Promise<void> {
  // Parse schema
  const schema = await parseSchema(schemaPath);

  // Execute plugins (NEW)
  const withPlugins = await executePlugins(schema);

  // Write back schema with plugin content
  await writeFile(schemaPath, withPlugins);

  // Re-parse for imports
  const updated = await parseSchema(schemaPath);

  // Continue with normal build...
  const graph = await buildDependencyGraph(schemaPath);
  // ...
}
```

### 4. Better Auth Plugin (Week 2)

Options:

**A. CLI-Based (Simpler):**
```typescript
export const betterAuthPlugin: PrismaPlugin = {
  async generate(config) {
    const { stdout } = await execAsync(
      `npx @better-auth/cli generate --config=${config.source}`
    );
    return extractSchemaFromOutput(stdout);
  },
};
```

**B. Config-Based (More Control):**
```typescript
export const betterAuthPlugin: PrismaPlugin = {
  async generate(config) {
    const authConfig = await loadAuthConfig(config.source);
    const models = [];

    if (authConfig.emailAndPassword) {
      models.push(BETTER_AUTH_USER_MODEL);
      models.push(BETTER_AUTH_ACCOUNT_MODEL);
    }

    return models.join('\n\n');
  },
};
```

---

## Example Usage

### Better Auth in Library

```prisma
// libs/api/prisma/schema.prisma

// @prisma-plugin: better-auth
// @prisma-plugin-config: {
//   "source": "../src/auth/auth.config.ts",
//   "provider": "postgresql",
//   "namespace": "auth"
// }

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["auth"]
}

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

// Plugin content will be generated here
```

### Build Command

```bash
pnpm tools prisma build libs/api/prisma/schema.prisma --plugins

# Output:
# ✓ Executing plugin: better-auth
# ✓ Generated 4 models from Better Auth
# ✓ Applied namespace: auth
# ✓ Schema built successfully!
```

### Application Importing Plugin-Generated Schema

```prisma
// apps/api/prisma/schema.prisma

// @prisma-import: @libs/api/prisma/schema.prisma

// The import will include all Better Auth models
```

---

## Advanced: Multiple Plugins

```prisma
// @prisma-plugin: better-auth
// @prisma-plugin-config: { "source": "../src/auth/auth.config.ts" }

// @prisma-plugin: audit-fields
// @prisma-plugin-config: { "models": ["User", "Post"], "fields": ["createdBy", "updatedBy"] }

// @prisma-plugin: soft-delete
// @prisma-plugin-config: { "models": ["User", "Post"] }

datasource db { ... }

// === PLUGIN: better-auth ===
model User { ... }
// === END PLUGIN ===

// === PLUGIN: audit-fields ===
// Adds createdBy/updatedBy to User and Post
// === END PLUGIN ===

// === PLUGIN: soft-delete ===
// Adds deletedAt to User and Post
// === END PLUGIN ===
```

---

## Benefits

1. **Automation:** No manual schema regeneration
2. **Consistency:** Single source of truth (auth config)
3. **Composition:** Plugins work with imports seamlessly
4. **Extensibility:** Easy to add new plugins
5. **Clarity:** Clear boundaries show what's generated
6. **Type Safety:** Generated schemas are validated
7. **DRY:** Don't duplicate Better Auth models manually

---

## Migration Path

### Step 1: Current State (Manual)
```bash
# Manually maintain Better Auth models in schema
```

### Step 2: With Plugin System
```prisma
// @prisma-plugin: better-auth
// @prisma-plugin-config: { "source": "../src/auth/auth.config.ts" }
```

```bash
pnpm tools prisma build libs/api/prisma/schema.prisma
# Automatically generates models from auth config
```

### Step 3: Application Uses Import
```prisma
// apps/api/prisma/schema.prisma
// @prisma-import: @libs/api/prisma/schema.prisma

// Gets all Better Auth models automatically
```

---

## Compatibility

### With Better Auth CLI

The plugin wraps Better Auth CLI:
```bash
# What the plugin runs internally:
npx @better-auth/cli generate \
  --config=../src/auth/auth.config.ts \
  --adapter=prisma \
  --provider=postgresql
```

### With Existing Build Tool

Plugins run **before** imports:
1. Execute plugins → generate models
2. Write to source schema
3. Parse imports → build graph
4. Merge schemas → compose
5. Final output

This ensures plugin-generated models can be imported by other schemas.

---

## Future Enhancements

### Plugin Discovery

```bash
pnpm tools prisma plugins list

Available plugins:
  - better-auth: Generate auth models from Better Auth config
  - audit-fields: Add audit fields to models
  - soft-delete: Add soft delete support
  - tenant-isolation: Add multi-tenancy support
```

### Plugin Install

```bash
pnpm tools prisma plugins install better-auth
pnpm tools prisma plugins install @myorg/custom-plugin
```

### Plugin Validation

```bash
pnpm tools prisma validate libs/api/prisma/schema.prisma

✓ Plugin: better-auth (valid config)
✓ Plugin: audit-fields (valid config)
✗ Plugin: custom-plugin (missing required config: "source")
```

---

## Code Structure

```
cli/tools/src/commands/prisma/
├── plugins/
│   ├── registry.ts          # Plugin registry and loader
│   ├── better-auth.ts       # Better Auth plugin
│   ├── audit-fields.ts      # Audit fields plugin (example)
│   ├── soft-delete.ts       # Soft delete plugin (example)
│   └── types.ts             # Plugin interfaces
├── plugin-executor.ts       # Execute plugins and insert content
├── parser.ts                # Add extractPlugins()
├── build.ts                 # Integrate plugins into build
└── types.ts                 # Add PluginDirective, PluginConfig
```

---

## Testing Strategy

### Unit Tests

```typescript
describe('Plugin System', () => {
  it('should extract plugin directives', () => {
    const schema = `
      // @prisma-plugin: better-auth
      // @prisma-plugin-config: { "source": "auth.ts" }
    `;

    const plugins = extractPlugins(schema);
    expect(plugins).toHaveLength(1);
    expect(plugins[0].name).toBe('better-auth');
  });

  it('should execute better-auth plugin', async () => {
    const plugin = pluginRegistry.get('better-auth');
    const result = await plugin.generate({
      source: '../src/auth/auth.config.ts',
    });

    expect(result).toContain('model User');
  });
});
```

### Integration Tests

```typescript
describe('Plugin Integration', () => {
  it('should build schema with better-auth plugin', async () => {
    const schema = await buildSchema({
      schemaPath: 'test/fixtures/with-better-auth.prisma',
    });

    // Verify plugin models are generated
    expect(schema).toContain('model User');
    expect(schema).toContain('// GENERATED BY PLUGIN: better-auth');
  });
});
```

---

## Recommendation

### Start Simple

1. **Add plugin directive parser** to existing parser.ts
2. **Create plugin registry** with better-auth as first plugin
3. **Integrate plugin execution** into build.ts (before imports)
4. **Use CLI-based approach** for Better Auth (leverage existing tool)
5. **Add plugin boundaries** similar to generation boundaries
6. **Test with real Better Auth config**

### Later Enhancements

- Config-based generation for offline support
- Multiple plugins
- Plugin validation command
- Plugin templates
- Third-party plugin support

---

## Decision Points

**Question 1:** Should plugins run on every build or only when config changes?
- **Recommendation:** Every build (simple, always correct)
- **Future:** Cache plugin output, rebuild only when config changes

**Question 2:** Should plugin content be committed to git?
- **Recommendation:** Yes (generated content is committed, like imports)
- **Rationale:** Reproducible builds, reviewable changes

**Question 3:** CLI-based or config-based generation?
- **Recommendation:** CLI-based for MVP
- **Future:** Config-based for advanced use cases

**Question 4:** Should plugins modify existing models or only generate new ones?
- **Recommendation:** Start with generation only
- **Future:** Allow transformation plugins

---

## Next Steps

If you approve this design, I can implement:

1. Plugin parser (extractPlugins function)
2. Plugin registry infrastructure
3. Better Auth plugin (CLI-based)
4. Plugin execution in build process
5. Plugin boundaries in output
6. Tests for plugin system

**Estimated Time:** 2-3 hours for MVP

**Would you like me to proceed with implementation?**

---

**End of Design Document**
